#!/bin/sh
#
# Pre-commit hook for MacAppTemplate
# Runs SwiftFormat and SwiftLint before allowing commits
#

echo "üîç Running pre-commit checks..."

# Get the list of staged Swift files
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.swift$")

if [ -z "$STAGED_SWIFT_FILES" ]; then
    echo "‚úÖ No Swift files to check"
    exit 0
fi

# Check if SwiftFormat is installed
if ! command -v swiftformat &> /dev/null; then
    echo "‚ö†Ô∏è  SwiftFormat not found. Install with: brew install swiftformat"
    echo "   Skipping format check..."
else
    echo "üìù Checking formatting with SwiftFormat..."
    
    # Run SwiftFormat in lint mode on staged files
    if ! echo "$STAGED_SWIFT_FILES" | xargs swiftformat --lint 2>/dev/null; then
        echo ""
        echo "‚ùå Formatting issues found!"
        echo "   Run 'swiftformat .' to fix them, then stage the changes."
        exit 1
    fi
    echo "‚úÖ Formatting OK"
fi

# Check if SwiftLint is installed
if ! command -v swiftlint &> /dev/null; then
    echo "‚ö†Ô∏è  SwiftLint not found. Install with: brew install swiftlint"
    echo "   Skipping lint check..."
else
    echo "üîç Running SwiftLint..."
    
    # Run SwiftLint on all staged files at once (more efficient and uses correct syntax)
    # shellcheck disable=SC2086
    if ! swiftlint lint --quiet --strict $STAGED_SWIFT_FILES; then
        echo ""
        echo "‚ùå SwiftLint violations found!"
        echo "   Fix the issues above before committing."
        echo "   Run 'swiftlint --fix' to auto-fix correctable issues."
        exit 1
    fi
    echo "‚úÖ Linting OK"
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
